{% load i18n %}

{% if request.htmx %}
<!-- Tab bar update via OOB swap (only on HTMX navigation) -->
<div id="dashboard-tabbar" hx-swap-oob="innerHTML">
<ion-footer>
{% include "customers/partials/tabbar_customer.html" with current_view='list' %}
</ion-footer>
</div>
{% endif %}

<div class="p-4" x-data="customerList()">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <ion-card>
            <ion-card-content class="flex items-center gap-4">
                <div class="p-3 rounded-full" style="background: var(--ion-color-primary-tint);">
                    <ion-icon name="people" style="font-size: 24px; color: var(--ion-color-primary);"></ion-icon>
                </div>
                <div>
                    <p class="text-sm" style="color: var(--ion-color-medium);">{% trans "Clientes Activos" %}</p>
                    <p class="text-2xl font-bold" style="color: var(--ion-text-color);">{{ total_customers }}</p>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card>
            <ion-card-content class="flex items-center gap-4">
                <div class="p-3 rounded-full" style="background: var(--ion-color-warning-tint);">
                    <ion-icon name="person-remove" style="font-size: 24px; color: var(--ion-color-warning);"></ion-icon>
                </div>
                <div>
                    <p class="text-sm" style="color: var(--ion-color-medium);">{% trans "Inactivos" %}</p>
                    <p class="text-2xl font-bold" style="color: var(--ion-text-color);">{{ inactive_customers }}</p>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card>
            <ion-card-content class="flex items-center gap-4">
                <div class="p-3 rounded-full" style="background: var(--ion-color-success-tint);">
                    <ion-icon name="trending-up" style="font-size: 24px; color: var(--ion-color-success);"></ion-icon>
                </div>
                <div>
                    <p class="text-sm" style="color: var(--ion-color-medium);">{% trans "Total" %}</p>
                    <p class="text-2xl font-bold" style="color: var(--ion-text-color);">{{ total_customers|add:inactive_customers }}</p>
                </div>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- Search and Filters -->
    <ion-card class="mb-4">
        <ion-card-content>
            <div class="flex flex-wrap gap-4 items-center">
                <ion-searchbar
                    x-model="searchQuery"
                    @ionInput="debouncedSearch()"
                    placeholder="{% trans 'Buscar por nombre, teléfono, email...' %}"
                    style="flex: 1; min-width: 200px;"
                    debounce="300">
                </ion-searchbar>

                <ion-segment x-model="statusFilter" @ionChange="loadCustomers()" value="active" style="max-width: 300px;">
                    <ion-segment-button value="active">
                        <ion-label>{% trans "Activos" %}</ion-label>
                    </ion-segment-button>
                    <ion-segment-button value="inactive">
                        <ion-label>{% trans "Inactivos" %}</ion-label>
                    </ion-segment-button>
                    <ion-segment-button value="all">
                        <ion-label>{% trans "Todos" %}</ion-label>
                    </ion-segment-button>
                </ion-segment>
            </div>
        </ion-card-content>
    </ion-card>

    <!-- Customer List -->
    <ion-card>
        <ion-card-content class="p-0">
            <!-- Loading -->
            <template x-if="loading">
                <div class="flex justify-center items-center py-12">
                    <ion-spinner name="crescent"></ion-spinner>
                </div>
            </template>

            <!-- Empty State -->
            <template x-if="!loading && customers.length === 0">
                <div class="text-center py-12" style="color: var(--ion-color-medium);">
                    <ion-icon name="people-outline" style="font-size: 64px;"></ion-icon>
                    <p class="mt-4">{% trans "No se encontraron clientes" %}</p>
                    <ion-button
                        class="mt-4"
                        hx-get="{% url 'customers:create' %}"
                        hx-target="#dashboard-content"
                        hx-push-url="true">
                        <ion-icon slot="start" name="person-add-outline"></ion-icon>
                        {% trans "Crear Primer Cliente" %}
                    </ion-button>
                </div>
            </template>

            <!-- Table -->
            <template x-if="!loading && customers.length > 0">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr style="background: var(--ion-color-light); border-bottom: 1px solid var(--ion-border-color);">
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase" style="color: var(--ion-color-medium);">{% trans "Nombre" %}</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase" style="color: var(--ion-color-medium);">{% trans "Contacto" %}</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold uppercase" style="color: var(--ion-color-medium);">{% trans "Total Gastado" %}</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold uppercase" style="color: var(--ion-color-medium);">{% trans "Visitas" %}</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold uppercase" style="color: var(--ion-color-medium);">{% trans "Última Compra" %}</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold uppercase" style="color: var(--ion-color-medium);">{% trans "Acciones" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="customer in customers" :key="customer.id">
                                <tr class="border-b hover:bg-opacity-50" style="border-color: var(--ion-border-color);">
                                    <td class="px-4 py-3">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-full flex items-center justify-center"
                                                 style="background: var(--ion-color-primary-tint);">
                                                <ion-icon name="person" style="color: var(--ion-color-primary);"></ion-icon>
                                            </div>
                                            <div>
                                                <p class="font-medium" style="color: var(--ion-text-color);" x-text="customer.name"></p>
                                                <p class="text-xs" style="color: var(--ion-color-medium);" x-text="customer.tax_id || '-'"></p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <p class="text-sm" style="color: var(--ion-text-color);" x-text="customer.phone || '-'"></p>
                                        <p class="text-xs" style="color: var(--ion-color-medium);" x-text="customer.email || '-'"></p>
                                    </td>
                                    <td class="px-4 py-3 text-right">
                                        <span class="font-semibold" style="color: var(--ion-color-success);" x-text="formatCurrency(customer.total_spent)"></span>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="px-2 py-1 rounded-full text-xs"
                                              style="background: var(--ion-color-primary-tint); color: var(--ion-color-primary);"
                                              x-text="customer.visit_count"></span>
                                    </td>
                                    <td class="px-4 py-3 text-center text-sm" style="color: var(--ion-color-medium);" x-text="customer.last_purchase || '-'"></td>
                                    <td class="px-4 py-3">
                                        <div class="flex gap-1 justify-center">
                                            <ion-button size="small" fill="clear"
                                                        :hx-get="'/modules/customers/' + customer.id + '/'"
                                                        hx-target="#dashboard-content"
                                                        hx-push-url="true"
                                                        title="{% trans 'Ver' %}">
                                                <ion-icon slot="icon-only" name="eye-outline"></ion-icon>
                                            </ion-button>
                                            <ion-button size="small" fill="clear"
                                                        :hx-get="'/modules/customers/' + customer.id + '/edit/'"
                                                        hx-target="#dashboard-content"
                                                        hx-push-url="true"
                                                        title="{% trans 'Editar' %}">
                                                <ion-icon slot="icon-only" name="create-outline"></ion-icon>
                                            </ion-button>
                                            <ion-button size="small" fill="clear" color="danger"
                                                        @click="confirmDelete(customer)"
                                                        title="{% trans 'Desactivar' %}">
                                                <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                                            </ion-button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </template>
        </ion-card-content>
    </ion-card>
</div>

<script>
function customerList() {
    return {
        customers: [],
        loading: true,
        searchQuery: '',
        statusFilter: 'active',
        searchTimeout: null,

        init() {
            this.loadCustomers();
        },

        debouncedSearch() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.loadCustomers();
            }, 300);
        },

        async loadCustomers() {
            this.loading = true;
            try {
                const params = new URLSearchParams({
                    search: this.searchQuery,
                    status: this.statusFilter
                });
                const response = await fetch(`{% url 'customers:list_ajax' %}?${params}`);
                const data = await response.json();
                if (data.success) {
                    this.customers = data.customers;
                    // Re-process HTMX on dynamic content
                    this.$nextTick(() => htmx.process(this.$el));
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            } finally {
                this.loading = false;
            }
        },

        formatCurrency(amount) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        },

        async confirmDelete(customer) {
            const alert = document.createElement('ion-alert');
            alert.header = '{% trans "Confirmar" %}';
            alert.message = `{% trans "¿Desactivar cliente" %} "${customer.name}"?`;
            alert.buttons = [
                {
                    text: '{% trans "Cancelar" %}',
                    role: 'cancel'
                },
                {
                    text: '{% trans "Desactivar" %}',
                    role: 'destructive',
                    handler: async () => {
                        try {
                            const response = await fetch(`/modules/customers/${customer.id}/delete/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}'
                                }
                            });
                            const data = await response.json();
                            if (data.success) {
                                this.loadCustomers();
                                const toast = document.createElement('ion-toast');
                                toast.message = data.message;
                                toast.duration = 2000;
                                toast.color = 'success';
                                document.body.appendChild(toast);
                                toast.present();
                            }
                        } catch (error) {
                            console.error('Error:', error);
                        }
                    }
                }
            ];
            document.body.appendChild(alert);
            await alert.present();
        }
    };
}
</script>
